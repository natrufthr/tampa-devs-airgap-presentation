kind: ZarfPackageConfig
metadata:
  name: istio
  description: argocd-w-istio
  version: 0.0.1
components:
  - name: create-cert
    actions:
      # runs during "zarf package deploy"
      onDeploy:
        defaults:
          dir: ""
          env: []
          maxRetries: 0
          maxTotalSeconds: 300
          mute: false
          shell:
            darwin: sh
            linux: sh
            windows: powershell
        before:
          - cmd: zarf tools gen-pki argocd.example.com
          - cmd: zarf tools kubectl create ns argocd
          - cmd: zarf tools kubectl create secret tls argocd-tls-cert --cert=tls.crt --key=tls.key -n istio-system
  - name: argocd
    required: true
    charts:
      - name: argo-cd
        version: 9.1.6
        namespace: argocd
        url: https://argoproj.github.io/argo-helm
        releaseName: argo-cd
        valuesFiles:
          - values.yaml
    images:
      - ecr-public.aws.com/docker/library/redis:8.2.2-alpine
      - ghcr.io/dexidp/dex:v2.44.0
      - quay.io/argoproj/argocd:v3.2.1
      # Cosign artifacts for images - argocd
      - ghcr.io/dexidp/dex:sha256-5d0656fce7d453c0e3b2706abf40c0d0ce5b371fb0b73b3cf714d05f35fa5f86.sig
      - quay.io/argoproj/argocd:sha256-a8532a23ed5f6e65afaf2a082b65fc74614549e54774f6b25fe3c993faa7bea3.sig
      - quay.io/argoproj/argocd:sha256-a8532a23ed5f6e65afaf2a082b65fc74614549e54774f6b25fe3c993faa7bea3.att
  - name: create-vs-n-gw
    actions:
      # runs during "zarf package deploy"
      onDeploy:
        defaults:
          dir: ""
          env: []
          maxRetries: 0
          maxTotalSeconds: 300
          mute: false
          shell:
            darwin: sh
            linux: sh
            windows: powershell
        after:
          - cmd: zarf tools kubectl apply -f gw.yaml
          - cmd: zarf tools kubectl apply -f vs.yaml
